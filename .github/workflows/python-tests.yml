name: Python CI with Poetry

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          poetry --version

      - name: Install dependencies
        run: poetry install

      - name: Set PYTHONPATH
        run: echo "PYTHONPATH=$GITHUB_WORKSPACE" >> $GITHUB_ENV

      - name: Run experiments and train models
        run: poetry run python run.py

      - name: Register model with MLflow
        run: poetry run python california_houseprice_prediction/domain/register_model.py

      - name: Set model alias
        run: poetry run python california_houseprice_prediction/application/fetch_model.py

      - name: Start API in background
        run: |
          poetry run uvicorn california_houseprice_prediction.application.api:app --host 0.0.0.0 --port 8000 &
          echo "API started on port 8000"

      - name: Run tests
        run: poetry run pytest tests/ -v

      - name: Test MLflow serving
        run: |
          # Démarrer le serveur MLflow
          poetry run mlflow models serve -m models:/sk-learn-gradient-boosting-reg@champion -p 5001 &
          sleep 10  # Attendre que le serveur démarre

          # Tester le modèle avec une requête
          curl -X POST http://localhost:5001/invocations -H "Content-Type: application/json" -d '{"inputs": [[8.3252, 41.0, 6.984127, 1.023810, 322.0, 2.555556, 37.88, -122.23]]}'

      - name: Notify Slack on failure
        if: failure()
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_MESSAGE: "CI/CD pipeline failed :x:"